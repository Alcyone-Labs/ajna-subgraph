# Ajna Pools Subgraph

[Ajna](https://www.ajna.finance/) is a non-custodial, peer-to-peer, permissionless lending, borrowing and trading system that requires no governance or external price feeds to function.

This Subgraph ingests the core Pool contracts used by the Ajna Protocol. These contracts can be found [here](https://github.com/ajna-finance/contracts).

This repository doesn't index the GrantFund contract found [here](https://github.com/ajna-finance/ecosystem-coordination). That indexing will be handled in a separate repository. The PoolInfoUtils contract is also not indexed here, as no events are emitted that can be indexed.


## Installation
Install using `yarn`, because `npm` has an issue installing [Gluegun](https://github.com/infinitered/gluegun).
```
sudo yarn global add @graphprotocol/graph-cli
yarn install
```

Configure `ETH_RPC_URL` for your target network in `.env`.

If you will change ABIs, please install `jq`.


## Querying
The dockerized deployment offers a query UI at http://localhost:8000/subgraphs/name/ajna/graphql.

Below are some examples of queries that can be made to the Ajna Subgraph.

List pools showing their tokens and how many transactions have been performed on them:
```
{
  pools {
    id
    txCount
    quoteToken {
      id
      symbol
    }
    collateralToken {
      id
      symbol
    }
  }
}
```

List lender positions across all pools:
```
{
  accounts {
    id
    lends {
      lpb
      bucket {
        bucketIndex
        quoteTokens
        collateral
      }
      pool {
        id
        actualUtilization
        currentDebt
        htp
        hpb
        lup
        maxBorrower
        poolSize
        reserves
        targetUtilization
        totalAjnaBurned
        totalInterestEarned
        quoteToken {
          symbol
        }
        collateralToken {
          symbol
        }
      }
    }
  }
}
```


## Design
### Types

| Value              | Type         |
| ------------------ | ------------ |
| Prices and amounts | `BigDecimal` |
| Bucket indicies    | `Int` (*u32* in AssemblyScript, *number* in TypeScript) |
| Counts and timestamps | `BigInt`  |

### Persistence / Rentention Policy

This subgraph does not retain a history of `Lends` and `Loans`.  `Lends` are discarded when all LP balance has been redeemed.  `Loans` are discarded when the lender has no debt and no collateral.

[Time-travel queries](https://thegraph.com/docs/en/querying/graphql-api/#time-travel-queries) can be used to query historical state.

This subgraph will retain a list of `Pools`, even if they have no liquidity. Pools will also retain a history of `LiquidationAuctions` and `ReserveAuctions`, which can be filtered by status.


## Development and Deployment
Commands for adding new data sources to the subgraph are listed in the [add-commands.txt](./add-commands.txt) file.

Once data sources have been added, entites can be modified in the [schema.graphql](./schema.graphql) file. After any update, the following commands must be run to ensure the new types are available for the event handlers:
```
yarn codegen
yarn build
```

After building, this subgraph can be run locally using provided docker container. To start, set the environment variable *ETH_RPC_URL* in your .env file. Then, run `docker-compose up`. Once the node is running, deploy the subgraph with:
```
yarn create-local
yarn deploy-local
```

Instructions on creating your own deployment are available in the [Graph Protocols Documentation](https://thegraph.com/docs/en/cookbook/quick-start/).


## Tests
Tests are written using the [Matchstick unit testing framework](https://github.com/LimeChain/matchstick/blob/main/README.md).

Run the Matchstick tests by executing: 
```
yarn test
```


## Maintenance
To update for new release candidates:
1. Update ABIs using the provided `copy-abis.sh` script.  This script requires `jq` be installed.  Note `codegen` and `build` commands are not sensitive to ABI formatting, but deployment is.  ABIs formatted by Ethers.js will not work.  ABIs generated by `graph add` will not work.  In the ABI, note that all _output_ parameters must have a `name` field.  It may be blank, but the field must exist.
2. Update addresses in `constants.ts` and `subgraph.yaml`.
3. Run `npm run codegen` to find and resolve errors in code generation.
4. Review contract changes, adjusting subgraph and schema accordingly.  
5. Run `npm run build` to and resolve compliation errors.  
6. Update handlers, test mocks, and unit tests.  Run `npm run test` to find and resolve issues.
7. Start the dockerized environment and perform a local deployment to confirm functionality.

To clean out container data and autogenerated code, run the `clean.sh` script.